<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>编译原理以及"hello world!"实现 | 皮特ᴾᵗ的Rust知识库</title>
    <meta name="description" content="个人Rust知识库，记录 & 分享个人碎片化、结构化、体系化的技术知识内容。">
    <meta name="generator" content="VitePress v1.0.2">
    <link rel="preload stylesheet" href="/assets/style.osiHB4KD.css" as="style">
    
    <script type="module" src="/assets/app.DgHgyL8N.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Bu8hRsVA.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/framework.coFu0xgG.js">
    <link rel="modulepreload" href="/assets/chunks/theme.CAIqAJ98.js">
    <link rel="modulepreload" href="/assets/chunks/ArticleMetadata.B6LTgUMn.js">
    <link rel="modulepreload" href="/assets/projects_rust_01-Rust实现Lua解释器_编译原理以及helloWorld实现.md.CRAQ_qA7.lean.js">
    <link rel="icon" href="/favicon.ico">
    <meta name="author" content="皮特ᴾᵗ">
    <meta name="keywords" content="皮特ᴾᵗ的Rust知识库, 知识库, 博客, 皮特ᴾᵗ">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="theme-color" content="#ffaf47">
    <meta property="og:type" content="website">
    <meta property="og:locale" content="zh_CN">
    <meta property="og:title" content="皮特ᴾᵗ的Rust知识库">
    <meta property="og:description" content="个人Rust知识库，记录 &amp; 分享个人碎片化、结构化、体系化的技术知识内容。">
    <meta property="og:site" content="https://rust.hyperter.top">
    <meta property="og:site_name" content="皮特ᴾᵗ的Rust知识库">
    <meta property="og:image" content="https://rust.hyperter.top/logo.jpg">
    <script>var _hmt=_hmt||[];(function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?53af4b1a12fbe40810ca7ad39f8db9c7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-20d51ff8><!--[--><!--]--><!--[--><span tabindex="-1" data-v-1066b111></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-1066b111> Skip to content </a><!--]--><!----><header class="VPNav" data-v-20d51ff8 data-v-a01966eb><div class="VPNavBar has-sidebar top" data-v-a01966eb data-v-c1adc913><div class="wrapper" data-v-c1adc913><div class="container" data-v-c1adc913><div class="title" data-v-c1adc913><div class="VPNavBarTitle has-sidebar" data-v-c1adc913 data-v-5277fb6c><a class="title" href="/" data-v-5277fb6c><!--[--><!--]--><!--[--><img class="VPImage logo" src="/logo.png" alt data-v-04ed9d27><!--]--><span data-v-5277fb6c>皮特ᴾᵗ的Rust知识库</span><!--[--><!--]--></a></div></div><div class="content" data-v-c1adc913><div class="content-body" data-v-c1adc913><!--[--><!--]--><div class="VPNavBarSearch search" data-v-c1adc913><!--[--><!----><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><span class="vp-icon DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-c1adc913 data-v-8232996e><span id="main-nav-aria-label" class="visually-hidden" data-v-8232996e>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-8232996e data-v-78135790><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-78135790><span class="text" data-v-78135790><!----><span data-v-78135790>分类</span><span class="vpi-chevron-down text-icon" data-v-78135790></span></span></button><div class="menu" data-v-78135790><div class="VPMenu" data-v-78135790 data-v-edbbb1ef><div class="items" data-v-edbbb1ef><!--[--><!--[--><div class="VPMenuLink" data-v-edbbb1ef data-v-5cdaff14><a class="VPLink link" href="/categories/rust/index" data-v-5cdaff14><!--[-->Rust基础<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup active" data-v-8232996e data-v-78135790><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-78135790><span class="text" data-v-78135790><!----><span data-v-78135790>项目</span><span class="vpi-chevron-down text-icon" data-v-78135790></span></span></button><div class="menu" data-v-78135790><div class="VPMenu" data-v-78135790 data-v-edbbb1ef><div class="items" data-v-edbbb1ef><!--[--><!--[--><div class="VPMenuLink" data-v-edbbb1ef data-v-5cdaff14><a class="VPLink link active" href="/projects/rust/01-Rust%E5%AE%9E%E7%8E%B0Lua%E8%A7%A3%E9%87%8A%E5%99%A8/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8AhelloWorld%E5%AE%9E%E7%8E%B0" data-v-5cdaff14><!--[-->Rust实现Lua解释器<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/tags" tabindex="0" data-v-8232996e data-v-bcf55b79><!--[--><span data-v-bcf55b79>标签</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/archives" tabindex="0" data-v-8232996e data-v-bcf55b79><!--[--><span data-v-bcf55b79>归档</span><!--]--></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-8232996e data-v-78135790><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-78135790><span class="text" data-v-78135790><!----><span data-v-78135790>关于</span><span class="vpi-chevron-down text-icon" data-v-78135790></span></span></button><div class="menu" data-v-78135790><div class="VPMenu" data-v-78135790 data-v-edbbb1ef><div class="items" data-v-edbbb1ef><!--[--><!--[--><div class="VPMenuLink" data-v-edbbb1ef data-v-5cdaff14><a class="VPLink link" href="/about/index" data-v-5cdaff14><!--[-->关于知识库<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-edbbb1ef data-v-5cdaff14><a class="VPLink link" href="/about/me" data-v-5cdaff14><!--[-->关于我<!--]--></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-c1adc913 data-v-8a4b67ab><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-8a4b67ab data-v-0db1f14b data-v-6c7482e1><span class="check" data-v-6c7482e1><span class="icon" data-v-6c7482e1><!--[--><span class="vpi-sun sun" data-v-0db1f14b></span><span class="vpi-moon moon" data-v-0db1f14b></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-c1adc913 data-v-8956f95a data-v-6551b446><!--[--><a class="VPSocialLink no-icon" href="https://github.com/hyperter96/rust-docs" aria-label="github" target="_blank" rel="noopener" data-v-6551b446 data-v-3f42d4b0><span class="vpi-social-github" /></a><a class="VPSocialLink no-icon" href="https://cs.hyperter.top/" aria-label target="_blank" rel="noopener" data-v-6551b446 data-v-3f42d4b0><svg width="33" height="33" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 174.8 204">
                <title>皮特ᴾᵗ的技术博客站</title>
                <path fill="#307AF2" d="M86.7,0l88,51v.2l-16.3,9.4v-.2L86.7,18.9Zm71.8,143.5,16.3,9.4v.2L86.8,204h0l-16.3-9.4,16.3-9.4h0l71.7-41.5v-.2Z"/>
                <path fill="#12D2AC" d="M16.3,143.5v.2L58,167.8l-16.3,9.4L0,153.1v-.2Z"/>
                <path fill="#12D2AC" d="M104.1,93,15.9,143.8l-.2-.1V124.9l.2.1L87.7,83.6,104.1,93Z"/>
                <path fill="#0057FE" d="M88.1,0,.1,51v.2l16.3,9.4v-.2L88.1,18.9Z"/>
                <path fill="#307AF2" d="M.1,50.9.2,152.6l.2.1,16.3-9.4-.2-.1-.1-82.9L.1,50.9Z"/>
                <path fill="#0057FE" d="M174.7,50.9l-.1,101.7-.2.1-16.3-9.4.2-.1.1-82.9Z"/>
                <path fill="#12D2AC" d="M41.7,158.5l16.1,9.4,100.6-58.7V90.4Z"/>
              </svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-c1adc913 data-v-64d41b80 data-v-78135790><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-78135790><span class="vpi-more-horizontal icon" data-v-78135790></span></button><div class="menu" data-v-78135790><div class="VPMenu" data-v-78135790 data-v-edbbb1ef><!----><!--[--><!--[--><!----><div class="group" data-v-64d41b80><div class="item appearance" data-v-64d41b80><p class="label" data-v-64d41b80>切换日光/暗黑模式</p><div class="appearance-action" data-v-64d41b80><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="Switch to dark theme" aria-checked="false" data-v-64d41b80 data-v-0db1f14b data-v-6c7482e1><span class="check" data-v-6c7482e1><span class="icon" data-v-6c7482e1><!--[--><span class="vpi-sun sun" data-v-0db1f14b></span><span class="vpi-moon moon" data-v-0db1f14b></span><!--]--></span></span></button></div></div></div><div class="group" data-v-64d41b80><div class="item social-links" data-v-64d41b80><div class="VPSocialLinks social-links-list" data-v-64d41b80 data-v-6551b446><!--[--><a class="VPSocialLink no-icon" href="https://github.com/hyperter96/rust-docs" aria-label="github" target="_blank" rel="noopener" data-v-6551b446 data-v-3f42d4b0><span class="vpi-social-github" /></a><a class="VPSocialLink no-icon" href="https://cs.hyperter.top/" aria-label target="_blank" rel="noopener" data-v-6551b446 data-v-3f42d4b0><svg width="33" height="33" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 174.8 204">
                <title>皮特ᴾᵗ的技术博客站</title>
                <path fill="#307AF2" d="M86.7,0l88,51v.2l-16.3,9.4v-.2L86.7,18.9Zm71.8,143.5,16.3,9.4v.2L86.8,204h0l-16.3-9.4,16.3-9.4h0l71.7-41.5v-.2Z"/>
                <path fill="#12D2AC" d="M16.3,143.5v.2L58,167.8l-16.3,9.4L0,153.1v-.2Z"/>
                <path fill="#12D2AC" d="M104.1,93,15.9,143.8l-.2-.1V124.9l.2.1L87.7,83.6,104.1,93Z"/>
                <path fill="#0057FE" d="M88.1,0,.1,51v.2l16.3,9.4v-.2L88.1,18.9Z"/>
                <path fill="#307AF2" d="M.1,50.9.2,152.6l.2.1,16.3-9.4-.2-.1-.1-82.9L.1,50.9Z"/>
                <path fill="#0057FE" d="M174.7,50.9l-.1,101.7-.2.1-16.3-9.4.2-.1.1-82.9Z"/>
                <path fill="#12D2AC" d="M41.7,158.5l16.1,9.4,100.6-58.7V90.4Z"/>
              </svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-c1adc913 data-v-55b44194><span class="container" data-v-55b44194><span class="top" data-v-55b44194></span><span class="middle" data-v-55b44194></span><span class="bottom" data-v-55b44194></span></span></button></div></div></div></div><div class="divider" data-v-c1adc913><div class="divider-line" data-v-c1adc913></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-20d51ff8 data-v-6eddf13b><div class="container" data-v-6eddf13b><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-6eddf13b><span class="vpi-align-left menu-icon" data-v-6eddf13b></span><span class="menu-text" data-v-6eddf13b>文章</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-6eddf13b data-v-2e0458a1><button data-v-2e0458a1>返回顶部</button><!----></div></div></div><aside class="VPSidebar" data-v-20d51ff8 data-v-c5d1c256><div class="curtain" data-v-c5d1c256></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-c5d1c256><span class="visually-hidden" id="sidebar-aria-label" data-v-c5d1c256> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-c5d1c256><section class="VPSidebarItem level-0 collapsible has-active" data-v-c5d1c256 data-v-4ee8d86c><div class="item" role="button" tabindex="0" data-v-4ee8d86c><div class="indicator" data-v-4ee8d86c></div><h2 class="text" data-v-4ee8d86c>Rust实现Lua解释器 (1篇)</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-4ee8d86c><span class="vpi-chevron-right caret-icon" data-v-4ee8d86c></span></div></div><div class="items" data-v-4ee8d86c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-4ee8d86c data-v-4ee8d86c><div class="item" data-v-4ee8d86c><div class="indicator" data-v-4ee8d86c></div><a class="VPLink link link" href="/projects/rust/01-Rust%E5%AE%9E%E7%8E%B0Lua%E8%A7%A3%E9%87%8A%E5%99%A8/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8AhelloWorld%E5%AE%9E%E7%8E%B0" data-v-4ee8d86c><!--[--><p class="text" data-v-4ee8d86c><div class="text-color-red mr-[6px]" style="font-weight: 550; display: inline-block;">1</div>编译原理以及"hello world!"实现</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-20d51ff8 data-v-43761193><div class="VPDoc has-sidebar has-aside" data-v-43761193 data-v-b91caced><!--[--><!--]--><div class="container" data-v-b91caced><div class="aside" data-v-b91caced><div class="aside-curtain" data-v-b91caced></div><div class="aside-container" data-v-b91caced><div class="aside-content" data-v-b91caced><div class="VPDocAside" data-v-b91caced data-v-97b6eccd><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-97b6eccd data-v-81e30c83><div class="content" data-v-81e30c83><div class="outline-marker" data-v-81e30c83></div><div class="outline-title" role="heading" aria-level="2" data-v-81e30c83>目录</div><nav aria-labelledby="doc-outline-aria-label" data-v-81e30c83><span class="visually-hidden" id="doc-outline-aria-label" data-v-81e30c83> Table of Contents for current page </span><ul class="VPDocOutlineItem root" data-v-81e30c83 data-v-f1679529><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-97b6eccd></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-b91caced><div class="content-container" data-v-b91caced><!--[--><!--]--><main class="main" data-v-b91caced><div style="position:relative;" class="vp-doc _projects_rust_01-Rust%E5%AE%9E%E7%8E%B0Lua%E8%A7%A3%E9%87%8A%E5%99%A8_%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8AhelloWorld%E5%AE%9E%E7%8E%B0" data-v-b91caced><div><h1 id="编译原理以及-hello-world-实现" tabindex="-1">编译原理以及&quot;hello world!&quot;实现 <a class="header-anchor" href="#编译原理以及-hello-world-实现" aria-label="Permalink to &quot;编译原理以及&quot;hello world!&quot;实现&quot;">​</a></h1><!----><h2 id="编译原理" tabindex="-1">编译原理 <a class="header-anchor" href="#编译原理" aria-label="Permalink to &quot;编译原理&quot;">​</a></h2><h3 id="编译型和解释型" tabindex="-1">编译型和解释型 <a class="header-anchor" href="#编译型和解释型" aria-label="Permalink to &quot;编译型和解释型&quot;">​</a></h3><p>无论什么编程语言，源代码在交给计算机执行之前，必然需要一个翻译的过程，以把源代码翻译成计算机可执行的语言。按照这个翻译的时机，编程语言大致可以分为2种：</p><ul><li>编译型，即编译器先将源代码编译成计算机语言，并生成可执行文件。后续由计算机直接执行此文件。比如在Linux下，用编译器gcc把C语言源码编译为可执行文件。</li><li>解释型，则需要一个解释器，实时地加载并解析源程序，然后将解析的结果对应到预先编译的功能并执行。这个解释器一般是由上面的编译型语言实现。</li></ul><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>  +-------+  编译   +----------+          +---------+  解析并执行   +----------+</span></span>
<span class="line"><span>  | 源代码 | -----&gt; | 可执行文件|          |  源代码  | ----------&gt; | Lua解释器 |</span></span>
<span class="line"><span>  | bar.c |         |  bar.exe |          | bar.lua |             |  lua.exe |</span></span>
<span class="line"><span>  +-------+        +----------+           +---------+             +----------+</span></span>
<span class="line"><span>                        ^                                               ^</span></span>
<span class="line"><span>                        |执行机器指令                                    |执行机器指令</span></span>
<span class="line"><span>                        |                                               |</span></span>
<span class="line"><span>                  +-------------+                                 +-------------+</span></span>
<span class="line"><span>                  |    计算机    |                                 |    计算机   |</span></span>
<span class="line"><span>                  +-------------+                                 +-------------+</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                编译型                                    解释型</span></span></code></pre></div><p>上图大致展示了两种类型的翻译和执行过程。Lua属于解释型语言，我们的目标也是要实现Lua解释器，所以下面只介绍这个类型。在此之前先明确几个名词的含义：</p><ul><li>编译（compile），这个名词的含义有点乱。广义上可以指任何将程序从一种计算机程序语言转换到另一种语言计算机语言的过程，比如“编译原理”这个词中的编译，再比如把Lua的源码转换为字节码的过程也可以认为是编译。狭义上特指上述的第一种类型，跟“解释型”相对。再狭义些，特指上述编译型过程的某个阶段，跟预处理、链接等过程并列。本文后续尽量避免使用这个名词。</li><li>解释（interpret），特指上述的第二种编译类型，跟“编译型”相对。</li><li>解析，是个笼统的概念，而非编译原理的专有名词。可指任何形式的转换，比如理解源码的语义，再比如把字符串解析为数字等。</li><li>翻译，对应编译的最广义的概念。</li><li>分析，这个词本身是个笼统的概念，但“词法分析”和“语法分析”是编译原理中的专有名词。</li></ul><h3 id="解析和执行" tabindex="-1">解析和执行 <a class="header-anchor" href="#解析和执行" aria-label="Permalink to &quot;解析和执行&quot;">​</a></h3><p>一般编译原理教程上介绍的编译过程如下：</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>       词法分析           语法分析         语义分析</span></span>
<span class="line"><span>字符流 --------&gt; Token流 --------&gt; 语法树 --------&gt; 中间代码 ...</span></span></code></pre></div><ul><li>其中字符流对应源代码，即把源代码作为字符流来处理。</li><li>词法分析，把字符流拆为语言支持的Token。比如上述Lua代码就拆为“<code>标识print</code>”和“字符串<code>&quot;hello, world!&quot;</code>”两个Token。Lua是忽略空白字符的。</li><li>语法分析，把Token流按照语法规则，解析为语法树。比如刚才的2个Token被识别为一条函数调用语句，其中“<code>标识print</code>”是函数名，“字符串<code>&quot;hello, world!&quot;</code>”是参数。</li><li>语义分析，把这条函数调用的语句生成对应的中间代码，这些代码指示从哪里查找函数体，把参数加载到什么位置等具体功能。</li></ul><p>生成中间代码之后，编译型和解释型语言就分道扬镳。编译型继续前进，最终生成可以直接执行的机器码，并包装为可执行文件。而对于解释型语言到此就告一段落，生成的中间代码（一般称为字节码）就是编译的结果；而字节码的执行就是虚拟机的任务了。</p><p>虚拟机把字节码转换为对应的一系列预先编译好的功能，然后执行这些功能。比如执行上述生成的字节码，虚拟机会首先找到对应的函数，即<code>print</code>，是Lua标准库里的函数；然后加载参数，即<code>&quot;hello, world&quot;</code>；最后调用<code>print</code>函数。这个函数也是预先编译好的，其功能是打印参数。这就最终完成了输出<code>&quot;hello, world!&quot;</code>的功能。</p><p>上述只是一般流程。具体到每个语言或者每个解释器流程可能有所不同。比如有的解释器可能不生成字节码，而是让虚拟机直接执行语法树。而Lua的官方实现则是省略了语法树，由语法分析直接生成字节码。这些选择各有优劣，但已超出我们的主题范围，这里不做讨论。我们的解释器在主流程上是完全参考的Lua官方实现，所以最终的流程如下：</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>       词法分析           语法分析</span></span>
<span class="line"><span>字符流 --------&gt; Token流 --------&gt; 字节码</span></span>
<span class="line"><span>                                    ^</span></span>
<span class="line"><span>                                    |</span></span>
<span class="line"><span>                                  虚拟机</span></span></code></pre></div><p>由此可以明确我们的解释器的主要功能组件：词法分析、语法分析和虚拟机。可以把词法分析和语法分析合并称为“解析”过程，而虚拟机是“执行”的过程，那么字节码就是连接这两个过程的纽带。解析和执行两个过程相对独立。接下来我们就以字节码作为突破口，开始实现我们的解释器。</p><h2 id="字节码" tabindex="-1">字节码 <a class="header-anchor" href="#字节码" aria-label="Permalink to &quot;字节码&quot;">​</a></h2><p>作为一个小白，要实现一个解释器，开始自然是一头雾水，无从下手。</p><p>好在上一节最后介绍了字节码，把整个解释器流程分为解析和执行两个阶段。那么我们就可以从字节码入手：</p><ul><li>先确定字节码，</li><li>然后让解析过程（词法分析和语法分析）努力生成这套字节码，</li><li>再让执行过程（虚拟机）努力执行这套字节码。</li></ul><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span>          生成             执行</span></span>
<span class="line"><span>    解析 -------&gt; 字节码 &lt;------- 虚拟机</span></span></code></pre></div><p>但字节码长什么样？如何定义？有什么类型？可以先参考Lua的官方实现。</p><h3 id="luac的输出" tabindex="-1"><code>luac</code>的输出 <a class="header-anchor" href="#luac的输出" aria-label="Permalink to &quot;`luac`的输出&quot;">​</a></h3><p>为方便叙述，这里再次列出目标代码：</p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">print</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;hello, world!&quot;</span></span></code></pre></div><p>Lua官方实现自带一个非常好用的工具，<code>luac</code>，即Lua Compiler，把源代码翻译为字节码并输出。是我们这个项目的最得力助手。看下其对<code>&quot;hello, world!&quot;</code>程序的输出：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">$</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> luac</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> -l</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> hello_world.lua</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">main</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">hello_world.lua:0,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">0&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> (5 </span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">instructions</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> at</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0x600000d78080</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">0+</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> params,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> slots,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> upvalue,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> locals,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> constants,</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> functions</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	[1]	VARARGPREP	0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    2</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	[1]	GETTABUP 	0 0 0	; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">_ENV</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> &quot;print&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    3</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	[1]	LOADK    	1 1	; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">&quot;hello, world!&quot;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    4</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	[1]	CALL     	0 2 1	; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">1</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> in</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> out</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    5</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">	[1]	RETURN   	0 1 1	; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">0</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;"> out</span></span></code></pre></div><h2 id="动手实现" tabindex="-1">动手实现 <a class="header-anchor" href="#动手实现" aria-label="Permalink to &quot;动手实现&quot;">​</a></h2><h3 id="程序入口main-rs" tabindex="-1">程序入口<code>main.rs</code> <a class="header-anchor" href="#程序入口main-rs" aria-label="Permalink to &quot;程序入口`main.rs`&quot;">​</a></h3><p>简单起见，我们的解释器只有一种工作方式，即接受一个参数作为Lua源码文件，然后解析并执行。代码如下：</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">use</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> std</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">::</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">env;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">use</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> std</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">fs</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">File</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">mod</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">mod</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> bytecode</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">mod</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> lex</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">mod</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> parse</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">mod</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> vm</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> args</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Vec</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">&gt; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> env</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">collect</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> args</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">len</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">        println!</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#96D0FF;">&quot;Usage: {} script&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, args[</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">]);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> File</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">open</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">args[</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">])</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">unwrap</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> proto </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> parse</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">load</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(file);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    vm</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">ExeState</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">new</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">execute</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">proto);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>开头2行引用了两个标准库。<code>env</code>用于获取命令行参数。<code>fs::File</code>用来打开Lua源文件。</p><p>然后看<code>main()</code>函数。前面几行是读取参数并打开源文件。在打开源文件时使用了<code>unwrap()</code>，如果打开失败则终止程序。简单起见，接下来几章对所有错误的处理方式都是直接终止程序，之后再统一引入规范的错误处理。</p><p>最后2行是核心功能：</p><ul><li>首先语法分析模块<code>parse</code>（内部调用词法分析<code>lex</code>）解析文件，并返回解析结果proto；</li><li>然后创建一个虚拟机，并执行<code>proto</code>。</li></ul><p>这个流程跟Lua官方实现的API调用方式不一样。Lua官方实现的主要流程如下（完整示例）：</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">lua_State </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">L</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> lua_open</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">();   </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 创建lua_State</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">luaL_loadfile</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">L</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, filename);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 解析，并把解析结果放在栈顶</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">lua_pcall</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">L</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">);       </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// 执行栈顶</span></span></code></pre></div><p>这是因为Lua官方实现是“库”，API对外只暴露<code>lua_State</code>这一个数据结构，负责解析和执行两部分的功能，所以要先创建<code>lua_State</code>，再以其为基础去调用解析和执行，解析结果也是通过<code>Lua_state</code>的栈来传递。而我们目前没有类似的统一的状态数据结构，所以只能先分别调用解析和执行两部分的功能。</p><p>下面分别看解析和执行过程。</p><h3 id="词法分析lex-rs" tabindex="-1">词法分析<code>lex.rs</code> <a class="header-anchor" href="#词法分析lex-rs" aria-label="Permalink to &quot;词法分析`lex.rs`&quot;">​</a></h3><p>虽然上面的<code>main()</code>函数里是直接调用的语法分析<code>parse</code>模块，但语法分析内部是调用了词法分析<code>lex</code>模块。先看词法分析。</p><p>词法分析的输出是<code>Token</code>流。对于<code>&quot;hello, world!&quot;</code>程序，只需用到“标识print”和“字符串<code>&quot;hello, world!&quot;</code>”这两个Token，简单起见我们也暂时只支持这两个。另外我们还定义一个<code>Eos</code>用于表示文件结束：</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">#[derive(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Debug</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> enum</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Token</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">    Name</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">    String</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">    Eos</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>我们并没有一次性把输入文件解析完毕，返回一个<code>Token</code>数组，而是提供一个类似迭代器的功能，以便让语法分析模块按需调用。为此先定义一个词法分析器：</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">#[derive(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;">Debug</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">)]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> struct</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Lex</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    input</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>现在暂时只包含一个成员，即输入文件。</p><p>对外提供2个API：<code>new()</code>基于输入文件创建语法分析器；<code>next()</code>返回下一个Token。</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">impl</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Lex</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(input</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> File</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> Self</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    pub</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;"> next</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">&amp;mut</span><span style="--shiki-light:#005CC5;--shiki-dark:#6CB6FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Token</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> ;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div><p>具体的解析过程就是单纯的字符串处理了，代码略过。</p><p>按照Rust的惯例，这里的<code>next()</code>函数的返回值应该是<code>Option&lt;Token&gt;</code>类型，<code>Some&lt;Token&gt;</code>表示读到新<code>Token</code>，<code>None</code>表示文件结束。但是既然<code>Token</code>本身就是一个<code>enum</code>了，直接在里面加入一个<code>Eos</code>似乎更方便些。而且如果改成<code>Option&lt;Token&gt;</code>类型，那么在下一次语法分析调用的地方，也会需要多一层判断，如下代码。所以还是选择了新增<code>Eos</code>类型。</p><div class="language-rust vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki shiki-themes github-light github-dark-dimmed vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">loop</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">    if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;"> let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F69D50;"> Some</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">(token) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> lex</span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#DCBDFB;">next</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">() {  </span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;">// extra check</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        match</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> token {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">            ...</span><span style="--shiki-light:#6A737D;--shiki-dark:#768390;"> // parse</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F47067;">        break</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ADBAC7;">}</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-b91caced data-v-4c599b76><!--[--><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--><!--]--><div class="edit-info" data-v-4c599b76><div class="edit-link" data-v-4c599b76><a class="VPLink link vp-external-link-icon no-icon edit-link-button" href="https://github.com/hyperter96/rust-docs/edit/main/docs/projects/rust/01-Rust实现Lua解释器/编译原理以及helloWorld实现.md" target="_blank" rel="noreferrer" data-v-4c599b76><!--[--><span class="vpi-square-pen edit-link-icon" data-v-4c599b76></span> 不妥之处，敬请雅正<!--]--></a></div><div class="last-updated" data-v-4c599b76><p class="VPLastUpdated" data-v-4c599b76 data-v-74ec1458>最后更新: <time datetime="2024-06-06T08:53:21.000Z" data-v-74ec1458></time></p></div></div><!----></footer><!--[--><!--[--><!--[--><div id="comment-container"></div><!--]--><!--]--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"categories_rust_01-rust语法入门_01-开发环境搭建.md\":\"CS_WGDXg\",\"archives.md\":\"BWPSYOgJ\",\"categories_rust_01-rust语法入门_02-变量与常见数据类型.md\":\"CqQwUk3Y\",\"categories_rust_01-rust语法入门_09-iterator迭代器.md\":\"C_LYi7Sh\",\"about_index.md\":\"DJgHR1E1\",\"categories_rust_01-rust语法入门_07-generic泛型.md\":\"D_-8G2et\",\"categories_rust_01-rust语法入门_06-borrowing借用与lifetime生命周期.md\":\"Cs2nOr7T\",\"projects_rust_01-rust实现lua解释器_编译原理以及helloworld实现.md\":\"CRAQ_qA7\",\"categories_rust_01-rust语法入门_10-closures闭包.md\":\"DFVINTq4\",\"categories_rust_index.md\":\"CmpNJ_7o\",\"categories_rust_01-rust语法入门_04-流程控制与函数.md\":\"CsNiR4dT\",\"categories_rust_01-rust语法入门_05-error错误处理.md\":\"VHRJ9z_2\",\"categories_rust_01-rust语法入门_08-trait特质.md\":\"BDLtr01r\",\"categories_rust_01-rust语法入门_03-ownership与结构体、枚举.md\":\"D4cRaGl6\",\"index.md\":\"C3hjmK0s\",\"about_me.md\":\"B9cla2hm\",\"tags.md\":\"DtwhStxc\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"皮特ᴾᵗ的Rust知识库\",\"description\":\"个人Rust知识库，记录 & 分享个人碎片化、结构化、体系化的技术知识内容。\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"分类\",\"items\":[{\"text\":\"Rust基础\",\"link\":\"/categories/rust/index\",\"activeMatch\":\"/categories/rust/\"}],\"activeMatch\":\"/categories/\"},{\"text\":\"项目\",\"items\":[{\"text\":\"Rust实现Lua解释器\",\"link\":\"/projects/rust/01-Rust实现Lua解释器/编译原理以及helloWorld实现\",\"activeMatch\":\"/projects/rust/\"}],\"activeMatch\":\"/projects/\"},{\"text\":\"标签\",\"link\":\"/tags\",\"activeMatch\":\"/tags\"},{\"text\":\"归档\",\"link\":\"/archives\",\"activeMatch\":\"/archives\"},{\"text\":\"关于\",\"items\":[{\"text\":\"关于知识库\",\"link\":\"/about/index\",\"activeMatch\":\"/about/index\"},{\"text\":\"关于我\",\"link\":\"/about/me\",\"activeMatch\":\"/about/me\"}],\"activeMatch\":\"/about/\"}],\"sidebar\":{\"/categories/rust/\":[{\"text\":\"Rust语法入门 (10篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>开发环境搭建\",\"link\":\"/categories/rust/01-Rust语法入门/01-开发环境搭建\"},{\"text\":\"<div class=\\\"text-color-orange mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">2</div>变量与常见数据类型\",\"link\":\"/categories/rust/01-Rust语法入门/02-变量与常见数据类型\"},{\"text\":\"<div class=\\\"text-color-yellow mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">3</div>Ownership与结构体、枚举\",\"link\":\"/categories/rust/01-Rust语法入门/03-Ownership与结构体、枚举\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">4</div>流程控制与函数\",\"link\":\"/categories/rust/01-Rust语法入门/04-流程控制与函数\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">5</div>Error错误处理\",\"link\":\"/categories/rust/01-Rust语法入门/05-Error错误处理\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">6</div>Borrowing借用 && Lifetime生命周期\",\"link\":\"/categories/rust/01-Rust语法入门/06-Borrowing借用与Lifetime生命周期\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">7</div>Generic泛型\",\"link\":\"/categories/rust/01-Rust语法入门/07-Generic泛型\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">8</div>Trait特质\",\"link\":\"/categories/rust/01-Rust语法入门/08-Trait特质\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">9</div>Iterator迭代器\",\"link\":\"/categories/rust/01-Rust语法入门/09-Iterator迭代器\"},{\"text\":\"<div class=\\\"text-color-gray mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">10</div>Closures闭包\",\"link\":\"/categories/rust/01-Rust语法入门/10-Closures闭包\"}],\"collapsed\":false}],\"/projects/rust/\":[{\"text\":\"Rust实现Lua解释器 (1篇)\",\"items\":[{\"text\":\"<div class=\\\"text-color-red mr-[6px]\\\" style=\\\"font-weight: 550; display: inline-block;\\\">1</div>编译原理以及\\\"hello world!\\\"实现\",\"link\":\"/projects/rust/01-Rust实现Lua解释器/编译原理以及helloWorld实现\"}],\"collapsed\":true}]},\"logo\":\"/logo.png\",\"outline\":{\"level\":\"deep\",\"label\":\"目录\"},\"darkModeSwitchLabel\":\"切换日光/暗黑模式\",\"sidebarMenuLabel\":\"文章\",\"returnToTopLabel\":\"返回顶部\",\"lastUpdatedText\":\"最后更新\",\"docFooter\":{\"prev\":\"上一篇\",\"next\":\"下一篇\"},\"editLink\":{\"pattern\":\"https://github.com/hyperter96/rust-docs/edit/main/docs/:path\",\"text\":\"不妥之处，敬请雅正\"},\"search\":{\"provider\":\"algolia\",\"options\":{\"appId\":\"FO0ZXQT0I4\",\"apiKey\":\"613ac947771af8273c39e9785f6d45ed\",\"indexName\":\"rust-hyperter\",\"locales\":{\"root\":{\"placeholder\":\"搜索文档\",\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"searchBox\":{\"resetButtonTitle\":\"清除查询条件\",\"resetButtonAriaLabel\":\"清除查询条件\",\"cancelButtonText\":\"取消\",\"cancelButtonAriaLabel\":\"取消\"},\"startScreen\":{\"recentSearchesTitle\":\"搜索历史\",\"noRecentSearchesText\":\"没有搜索历史\",\"saveRecentSearchButtonTitle\":\"保存至搜索历史\",\"removeRecentSearchButtonTitle\":\"从搜索历史中移除\",\"favoriteSearchesTitle\":\"收藏\",\"removeFavoriteSearchButtonTitle\":\"从收藏中移除\"},\"errorScreen\":{\"titleText\":\"无法获取结果\",\"helpText\":\"你可能需要检查你的网络连接\"},\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\",\"closeText\":\"关闭\",\"searchByText\":\"搜索提供者\"},\"noResultsScreen\":{\"noResultsText\":\"无法找到相关结果\",\"suggestedQueryText\":\"你可以尝试查询\",\"reportMissingResultsText\":\"你认为该查询应该有结果？\",\"reportMissingResultsLinkText\":\"点击反馈\"}}}}}}},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/hyperter96/rust-docs\"},{\"icon\":{\"svg\":\"<svg width=\\\"33\\\" height=\\\"33\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" viewBox=\\\"0 0 174.8 204\\\">\\n                <title>皮特ᴾᵗ的技术博客站</title>\\n                <path fill=\\\"#307AF2\\\" d=\\\"M86.7,0l88,51v.2l-16.3,9.4v-.2L86.7,18.9Zm71.8,143.5,16.3,9.4v.2L86.8,204h0l-16.3-9.4,16.3-9.4h0l71.7-41.5v-.2Z\\\"/>\\n                <path fill=\\\"#12D2AC\\\" d=\\\"M16.3,143.5v.2L58,167.8l-16.3,9.4L0,153.1v-.2Z\\\"/>\\n                <path fill=\\\"#12D2AC\\\" d=\\\"M104.1,93,15.9,143.8l-.2-.1V124.9l.2.1L87.7,83.6,104.1,93Z\\\"/>\\n                <path fill=\\\"#0057FE\\\" d=\\\"M88.1,0,.1,51v.2l16.3,9.4v-.2L88.1,18.9Z\\\"/>\\n                <path fill=\\\"#307AF2\\\" d=\\\"M.1,50.9.2,152.6l.2.1,16.3-9.4-.2-.1-.1-82.9L.1,50.9Z\\\"/>\\n                <path fill=\\\"#0057FE\\\" d=\\\"M174.7,50.9l-.1,101.7-.2.1-16.3-9.4.2-.1.1-82.9Z\\\"/>\\n                <path fill=\\\"#12D2AC\\\" d=\\\"M41.7,158.5l16.1,9.4,100.6-58.7V90.4Z\\\"/>\\n              </svg>\"},\"link\":\"https://cs.hyperter.top/\"}],\"articleMetadataConfig\":{\"author\":\"皮特ᴾᵗ\",\"authorLink\":\"/about/me\",\"showViewCount\":false},\"copyrightConfig\":{\"license\":\"署名-相同方式共享 4.0 国际 (CC BY-SA 4.0)\",\"licenseLink\":\"http://creativecommons.org/licenses/by-sa/4.0/\"},\"commentConfig\":{\"type\":\"gitalk\",\"showComment\":true},\"footerConfig\":{\"showFooter\":true,\"copyright\":\"Copyright © 2024-2024 MIT License | 皮特ᴾᵗ\"}},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>